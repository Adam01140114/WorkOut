<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
     <title>WorkSmart - Calorie Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg: #0b0f14;
      --card: #121821;
      --muted: #8aa0b4;
      --text: #e9f0f6;
      --accent: #6ee7b7;
      --accent-2: #60a5fa;
      --danger: #f87171;
      --ring: rgba(110,231,183,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui;-webkit-font-smoothing:antialiased;color:var(--text);background:var(--bg);padding:24px}
    .wrap{max-width:880px;margin:0 auto}
    h1,h2,h3{text-align:center}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;margin-bottom:18px}
    .field{margin-bottom:12px;text-align:left}
    .label{font-size:14px;color:var(--muted);margin-bottom:4px;display:block;text-align:left}
    input, select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0e141b;color:var(--text)}
    button{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:600;display:block;margin:8px auto}
    .primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#081018}
    .ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,.2)}
    .result{margin-top:10px;min-height:38px;text-align:left}
    .math{background:#0c1218;border:1px dashed rgba(255,255,255,.2);padding:8px;border-radius:10px;font-family:monospace;white-space:pre-wrap}
    canvas{background:#0e141b;border-radius:10px;padding:10px}
    .hidden{display:none}
    .menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .menu-tile{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;border:1px solid rgba(255,255,255,.15);border-radius:14px;background:#0e141b;cursor:pointer}
    .menu-emoji{font-size:28px}
    .row{display:flex;gap:8px;justify-content:flex-start}
    
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal-overlay.hidden {
      display: none !important;
    }
    
    /* always above slides/titles on mobile */
    .modal-overlay { z-index: 9999 !important; }
    .modal { position: relative; z-index: 10000; }
    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .modal-icon {
      font-size: 24px;
    }
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    .modal-subtitle {
      color: var(--muted);
      font-size: 14px;
      margin: 4px 0 0 0;
    }
    .auth-toggle {
      text-align: center;
      margin-top: 16px;
      color: var(--muted);
    }
    .auth-toggle a {
      color: var(--accent-2);
      text-decoration: none;
      cursor: pointer;
    }
    .error-message {
      color: var(--danger);
      font-size: 14px;
      margin-top: 8px;
      text-align: center;
    }
    .success-message {
      color: var(--accent);
      font-size: 14px;
      margin-top: 8px;
      text-align: center;
    }
    
    /* Profile Setup Styles */
    .profile-setup {
      text-align: center;
      margin-bottom: 20px;
    }
    .profile-setup h3 {
      margin-bottom: 16px;
    }
    
         /* Settings and Logout Section */
     .user-actions {
       display: flex;
       flex-direction: column;
       gap: 8px;
       margin-top: 16px;
       align-items: center;
     }
     .user-actions button {
       margin: 0;
       width: auto;
       min-width: 120px;
       background: linear-gradient(135deg,var(--accent),var(--accent-2));
       color: #081018;
     }
     .settings-btn {
       background: linear-gradient(135deg,var(--accent),var(--accent-2));
       color: #081018;
     }
     .logout-btn {
       background: linear-gradient(135deg,var(--accent),var(--accent-2));
       color: #081018;
     }
     .danger-btn {
       background: var(--danger);
       color: white;
     }
     
     /* Mobile Swipe Navigation */
     .mobile-container {
       display: none;
       overflow: hidden;
       position: relative;
       width: 100%;
       height: 100vh;
       padding-top: 60px; /* Add space for title */
     }
     
     .mobile-title {
       position: fixed;
       top: 0;
       left: 0;
       right: 0;
       background: var(--bg);
       padding: 16px;
       text-align: center;
       font-size: 18px;
       font-weight: bold;
       z-index: 200;
       border-bottom: 1px solid rgba(255,255,255,0.1);
     }
     
     .mobile-slide {
       position: absolute;
       width: 100%;
       height: calc(100vh - 60px);
       transition: transform 0.3s ease-in-out;
       padding: 20px;
       box-sizing: border-box;
       display: none;
       flex-direction: column;
       justify-content: flex-start;
       overflow-y: auto;
       -webkit-overflow-scrolling: touch; /* Enable smooth scrolling on iOS */
     }
     
     .mobile-slide.active {
       transform: translateX(0);
       z-index: 10;
     }
     
     .mobile-slide.prev {
       transform: translateX(-100%);
       z-index: 5;
     }
     
     .mobile-slide.next {
       transform: translateX(100%);
       z-index: 5;
     }
     
     .mobile-slide-content {
       background: var(--card);
       border-radius: var(--radius);
       padding: 24px;
       margin-bottom: 16px;
       box-shadow: 0 4px 20px rgba(0,0,0,0.3);
       flex: none; /* Don't expand to fill space */
       max-height: 70vh; /* Limit height to 70% of viewport */
       overflow-y: auto;
     }
     
     .mobile-slide-content h2 {
       margin-top: 0;
       margin-bottom: 16px;
       text-align: center;
       font-size: 20px;
     }
     
     .mobile-slide-content canvas {
       margin-bottom: 16px;
       max-height: 200px;
     }
     
     .mobile-slide-content .user-actions {
       margin-top: 0;
     }
     
     .mobile-slide-content .user-actions button {
       margin-bottom: 8px;
       width: 100%;
     }
     
     .mobile-slide-content .user-actions button:last-child {
       margin-bottom: 0;
     }
     
     .mobile-indicators {
       position: fixed;
       bottom: 20px;
       left: 50%;
       transform: translateX(-50%);
       display: flex;
       gap: 8px;
       z-index: 100;
     }
     
     .mobile-indicator {
       width: 8px;
       height: 8px;
       border-radius: 50%;
       background: var(--muted);
       transition: background 0.3s ease;
     }
     
     .mobile-indicator.active {
       background: var(--accent);
     }
     
     /* Desktop styles */
     .desktop-container {
       display: block;
     }
     
     /* Mobile styles */
     @media (max-width: 768px) {
       .desktop-container {
         display: none;
       }
       
       .mobile-container {
         display: block;
       }
       
       body {
         padding: 0;
         margin: 0;
         overflow: hidden;
       }
       
       .wrap {
         max-width: none;
         margin: 0;
         padding: 0;
       }
       
       h1 {
         display: none; /* Hide desktop title on mobile */
       }
       
       .mobile-slide.active {
         overflow-y: auto;
         -webkit-overflow-scrolling: touch;
       }
       
       .modal-overlay {
         overflow-y: auto;
         -webkit-overflow-scrolling: touch;
       }
     }
  </style>
</head>
<body>
     <div class="wrap">
     <h1>WorkSmart - Calorie Tracker</h1>

     <!-- Mobile Container -->
     <div class="mobile-container">
       <!-- Mobile Title -->
       <div class="mobile-title">Smart Calorie Tracker</div>
       
       <!-- Slide 1: Total Calories Burned -->
       <div class="mobile-slide active" id="mobile-slide-1">
         <br>
         <div class="mobile-slide-content">
           <h2>Total Calorie Deficit</h2>
           <canvas id="mobileTotalChart" height="200"></canvas>
           <button class="ghost" id="mobileToggleFat">Show More</button>
           <button class="primary" id="mobileAddCaloriesBtn">Add Calories</button>
         </div>
       </div>

       <!-- Slide 2: Calories Burned With Workouts -->
       <div class="mobile-slide next" id="mobile-slide-2">
         <br>
         <div class="mobile-slide-content">
           <h2>Calories Burnt With Workouts</h2>
           <canvas id="mobileWorkoutChart" height="200"></canvas>
           <button class="ghost" id="mobileToggleWorkoutFat">Show Fat Loss</button>
           <button class="primary" id="mobileShowWorkouts">Show Workouts</button>
         </div>
       </div>

       <!-- Slide 3: Foods Eaten -->
       <div class="mobile-slide next" id="mobile-slide-3">
         <br>
         <div class="mobile-slide-content">
           <h2>Foods Eaten</h2>
           <canvas id="mobileFoodChart" height="200"></canvas>
           <button class="ghost" id="mobileToggleFoodFat">Show Fat Loss</button>
           <button class="primary" id="mobileShowFoods">Show Foods</button>
         </div>
       </div>

       <!-- Slide 4: Weight Trajectory -->
       <div class="mobile-slide next" id="mobile-slide-4">
         <br>
         <div class="mobile-slide-content">
           <h2>Weight Trajectory</h2>
           <canvas id="mobileWeightChart" height="200"></canvas>
           <button class="ghost" id="mobileToggleWeightFat">Show Fat Loss</button>
           <button class="primary" id="mobileAddWeightBtn">Edit Weight</button>
         </div>
       </div>

       <!-- Slide 5: User Profile -->
       <div class="mobile-slide next" id="mobile-slide-5">
         <br>
         <div class="mobile-slide-content">
           <h2>User Profile</h2>
           <div class="user-actions">
             <button class="settings-btn" id="mobileOpenSettings" disabled>Settings</button>
             <button class="danger-btn" id="mobileDeleteAccountBtn">Delete Account</button>
             <button class="logout-btn" id="mobileLogoutBtn">Logout</button>
           </div>
         </div>
       </div>

       <!-- Mobile Indicators -->
       <div class="mobile-indicators">
         <div class="mobile-indicator active"></div>
         <div class="mobile-indicator"></div>
         <div class="mobile-indicator"></div>
         <div class="mobile-indicator"></div>
         <div class="mobile-indicator"></div>
       </div>
     </div> 
     <!-- Desktop Container -->
     <div class="desktop-container">

     <!-- Authentication Modal -->
    <div id="authModal" class="modal-overlay hidden">
      <div class="modal">
        <!-- Login Form -->
        <div id="loginForm">
          <div class="modal-header">
            <div class="modal-icon">üîì</div>
                         <div>
               <h3 class="modal-title">Welcome Back</h3>
               <p class="modal-subtitle">Sign in to access your workout tracker</p>
             </div>
          </div>
          <div class="field">
            <label class="label">EMAIL ADDRESS</label>
            <input id="loginEmail" type="email" placeholder="Enter your email" />
          </div>
          <div class="field">
            <label class="label">PASSWORD</label>
            <input id="loginPassword" type="password" placeholder="Enter your password" />
          </div>
                     <button class="primary" id="loginBtn">Sign In</button>
           <div class="auth-toggle">
             Don't have an account? <a id="showSignup">Create one here</a>
           </div>
                       <div id="loginError" class="error-message hidden"></div>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" class="hidden">
          <div class="modal-header">
            <div class="modal-icon">üöÄ</div>
                         <div>
               <h3 class="modal-title">Create Account</h3>
               <p class="modal-subtitle">Join WorkSmart and track your fitness journey</p>
             </div>
          </div>
          <div class="field">
            <label class="label">EMAIL ADDRESS</label>
            <input id="signupEmail" type="email" placeholder="Enter your email" />
          </div>
          <div class="field">
            <label class="label">PASSWORD</label>
            <input id="signupPassword" type="password" placeholder="Enter your password" />
            <small style="color: var(--muted); font-size: 12px;">Minimum 6 characters</small>
          </div>
          <div class="field">
            <label class="label">CONFIRM PASSWORD</label>
            <input id="confirmPassword" type="password" placeholder="Confirm your password" />
          </div>
          <button class="primary" id="signupBtn">Create Account</button>
          <div class="auth-toggle">
            Already have an account? <a id="showLogin">Sign in here</a>
          </div>
          <div id="signupError" class="error-message hidden"></div>
        </div>
      </div>
    </div>

    <!-- Profile Setup Modal -->
    <div id="profileModal" class="modal-overlay hidden">
      <div class="modal">
        <div class="profile-setup">
          <h3>Complete Your Profile</h3>
          <p>Let's calculate your BMR to get started</p>
        </div>
        <div class="field">
          <label class="label" for="setupAge">Age</label>
          <input id="setupAge" type="number" placeholder="22" />
        </div>
        <div class="field">
          <label class="label">Height</label>
          <div class="row">
            <input id="setupHeightFt" type="number" placeholder="5" />
            <input id="setupHeightIn" type="number" placeholder="9" />
          </div>
        </div>
        <div class="field">
          <label class="label" for="setupWeight">Weight (lb)</label>
          <input id="setupWeight" type="number" placeholder="170" />
        </div>
        <div class="result" id="setupResult"></div>
        <button class="primary" id="saveProfileBtn">Save Profile</button>
        <div id="profileError" class="error-message hidden"></div>
      </div>
    </div>

         <!-- Settings Modal -->
     <div id="settingsModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">‚öôÔ∏è</div>
           <div>
             <h3 class="modal-title">User Settings</h3>
             <p class="modal-subtitle">Update your profile information</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="settingsAge">Age</label>
           <input id="settingsAge" type="number" />
         </div>
         <div class="field">
           <label class="label">Height</label>
           <div class="row">
             <input id="settingsHeightFt" type="number" />
             <input id="settingsHeightIn" type="number" />
           </div>
         </div>
         <div class="field">
           <label class="label" for="settingsWeight">Weight (lb)</label>
           <input id="settingsWeight" type="number" />
         </div>
         <div class="user-actions">
           <button class="primary" id="saveSettings">Save</button>
           <button class="ghost" id="cancelSettings">Back</button>
         </div>
         <div id="settingsError" class="error-message hidden"></div>
         <div id="settingsSuccess" class="success-message hidden"></div>
       </div>
     </div>

     <!-- Add Calories Modal -->
     <div id="addCaloriesModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üî•</div>
           <div>
             <h3 class="modal-title">Add Calories</h3>
             <p class="modal-subtitle">Log your activity calories</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="caloriesAmount">Calories</label>
           <input id="caloriesAmount" type="number" placeholder="Enter calories (positive or negative)" />
           <small style="color: var(--muted); font-size: 12px;">Use negative values to subtract calories</small>
         </div>
         <div class="field">
           <label class="label" for="caloriesDate">Date</label>
           <input id="caloriesDate" type="date" />
         </div>
         <div class="user-actions">
           <button class="primary" id="submitAddCalories">Submit</button>
           <button class="ghost" id="cancelAddCalories">Cancel</button>
         </div>
         <div id="addCaloriesError" class="error-message hidden"></div>
         <div id="addCaloriesSuccess" class="success-message hidden"></div>
       </div>
     </div>

     <!-- Weight Logging Modal -->
     <div id="weightLoggingModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">‚öñÔ∏è</div>
           <div>
             <h3 class="modal-title">Daily Weight Check</h3>
             <p class="modal-subtitle">Have you weighed yourself today?</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="dailyWeight">Weight (lb)</label>
           <input id="dailyWeight" type="number" step="0.1" placeholder="Enter your weight" />
         </div>
         <div class="user-actions">
           <button class="primary" id="submitDailyWeight">Submit</button>
           <button class="ghost" id="maybeLaterWeight">Maybe Later</button>
           <button class="ghost" id="closeWeightModal">Close</button>
         </div>
         <div id="weightLoggingError" class="error-message hidden"></div>
       </div>
     </div>

     <!-- Add Weight Modal -->
     <div id="addWeightModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">‚öñÔ∏è</div>
           <div>
             <h3 class="modal-title">Add Weight</h3>
             <p class="modal-subtitle">Log your weight for a specific date</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="weightAmount">Weight (lb)</label>
           <input id="weightAmount" type="number" step="0.1" placeholder="Enter your weight" />
         </div>
         <div class="field">
           <label class="label" for="weightDate">Date</label>
           <input id="weightDate" type="date" />
         </div>
         <div class="user-actions">
           <button class="primary" id="submitAddWeight">Submit</button>
           <button class="ghost" id="cancelAddWeight">Cancel</button>
         </div>
         <div id="addWeightError" class="error-message hidden"></div>
         <div id="addWeightSuccess" class="success-message hidden"></div>
       </div>
     </div>

     <!-- Mobile Workout Menu Modal -->
     <div id="mobileWorkoutModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üèãÔ∏è</div>
           <div>
             <h3 class="modal-title">Choose a Workout</h3>
             <p class="modal-subtitle">Select your workout type</p>
           </div>
         </div>
         <div class="menu-grid" style="margin-bottom: 20px;">
           <div class="menu-tile" id="mobileOpenTreadmill">
             <div class="menu-emoji">üèÉ‚Äç‚ôÇÔ∏è</div>
             <div>Treadmill</div>
           </div>
           <div class="menu-tile" id="mobileOpenStairs">
             <div class="menu-emoji">üßó</div>
             <div>Stair Master</div>
           </div>
         </div>
         <div class="user-actions">
           <button class="ghost" id="closeMobileWorkoutMenu">Close</button>
         </div>
       </div>
     </div>

     <!-- Mobile Treadmill Modal -->
     <div id="mobileTreadmillModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üèÉ‚Äç‚ôÇÔ∏è</div>
           <div>
             <h3 class="modal-title">Treadmill Calories</h3>
             <p class="modal-subtitle">ACSM Walking Equation</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="mobileTspeed">Speed (mph)</label>
           <input id="mobileTspeed" type="number" step="0.1" placeholder="3.5" />
         </div>
         <div class="field">
           <label class="label" for="mobileTgrade">Incline (%)</label>
           <input id="mobileTgrade" type="number" step="0.1" placeholder="7.5" />
         </div>
         <div class="field">
           <label class="label" for="mobileTdur">Duration (min)</label>
           <input id="mobileTdur" type="number" placeholder="30" />
         </div>
         <div class="result" id="mobileTresult"></div>
         <div class="user-actions">
           <button class="primary" id="mobileTcalc">Calculate Calories</button>
           <button class="ghost" id="closeMobileTreadmill">Close</button>
         </div>
       </div>
     </div>

     <!-- Mobile Stairs Modal -->
     <div id="mobileStairsModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üßó</div>
           <div>
             <h3 class="modal-title">Stair Master Calories</h3>
             <p class="modal-subtitle">MET Method</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="mobileSdur">Duration (min)</label>
           <input id="mobileSdur" type="number" placeholder="20" />
         </div>
         <div class="field">
           <label class="label" for="mobileSintensity">Intensity</label>
           <select id="mobileSintensity">
             <option value="6">Easy ¬∑ 6 MET</option>
             <option value="8.8" selected>Moderate ¬∑ 8.8 MET</option>
             <option value="10.3">Hard ¬∑ 10.3 MET</option>
             <option value="custom">Custom MET</option>
           </select>
         </div>
         <div class="field hidden" id="mobileCustomMetField">
           <label class="label" for="mobileScustom">Custom MET</label>
           <input id="mobileScustom" type="number" step="0.1" placeholder="9.5" />
         </div>
         <div class="result" id="mobileSresult"></div>
         <div class="user-actions">
           <button class="primary" id="mobileScalc">Calculate Calories</button>
           <button class="ghost" id="closeMobileStairs">Close</button>
         </div>
       </div>
     </div>

     <!-- Mobile Food Menu Modal -->
     <div id="mobileFoodModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üçΩÔ∏è</div>
           <div>
             <h3 class="modal-title">Choose Food</h3>
             <p class="modal-subtitle">Select your food type</p>
           </div>
         </div>
         <div class="menu-grid" style="margin-bottom: 20px;">
           <div class="menu-tile" id="mobileOpenTacos">
             <div class="menu-emoji">üåÆ</div>
             <div>Tacos</div>
           </div>
           <div class="menu-tile" id="mobileOpenBurger">
             <div class="menu-emoji">üçî</div>
             <div>Burger</div>
           </div>
         </div>
         <div class="user-actions">
           <button class="primary" id="mobileAddCustomFood" style="background: #60a5fa; color: white;">Add Foods</button>
           <button class="ghost" id="closeMobileFoodMenu">Close</button>
         </div>
       </div>
     </div>

     <!-- Mobile Tacos Modal -->
     <div id="mobileTacosModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üåÆ</div>
           <div>
             <h3 class="modal-title">Taco Calories</h3>
             <p class="modal-subtitle">Log your taco consumption</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="mobileTacoName">Name</label>
           <input id="mobileTacoName" type="text" placeholder="e.g., Beef Taco" />
         </div>
         <div class="field">
           <label class="label" for="mobileTacoCalories">Calories</label>
           <input id="mobileTacoCalories" type="number" placeholder="250" />
         </div>
         <div class="field">
           <label class="label" for="mobileTacoQuantity">Quantity</label>
           <input id="mobileTacoQuantity" type="number" placeholder="2" />
         </div>
         <div class="result" id="mobileTacoResult"></div>
         <div class="user-actions">
           <button class="primary" id="mobileTacoCalc">Calculate Calories</button>
           <button class="ghost" id="closeMobileTacos">Close</button>
         </div>
       </div>
     </div>

     <!-- Mobile Burger Modal -->
     <div id="mobileBurgerModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon">üçî</div>
           <div>
             <h3 class="modal-title">Burger Calories</h3>
             <p class="modal-subtitle">Log your burger consumption</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="mobileBurgerName">Name</label>
           <input id="mobileBurgerName" type="text" placeholder="e.g., Cheeseburger" />
         </div>
         <div class="field">
           <label class="label" for="mobileBurgerCalories">Calories</label>
           <input id="mobileBurgerCalories" type="number" placeholder="500" />
         </div>
         <div class="field">
           <label class="label" for="mobileBurgerQuantity">Quantity</label>
           <input id="mobileBurgerQuantity" type="number" placeholder="1" />
         </div>
         <div class="result" id="mobileBurgerResult"></div>
         <div class="user-actions">
           <button class="primary" id="mobileBurgerCalc">Calculate Calories</button>
           <button class="ghost" id="closeMobileBurger">Close</button>
         </div>
       </div>
     <!-- Mobile Custom Food Modal -->
     <div id="mobileCustomFoodModal" class="modal-overlay hidden">
       <div class="modal">
         <div class="modal-header">
           <div class="modal-icon" id="customFoodIcon">üçΩÔ∏è</div>
           <div>
             <h3 class="modal-title">Add Custom Food</h3>
             <p class="modal-subtitle">Create your own food entry</p>
           </div>
         </div>
         <div class="field">
           <label class="label" for="mobileCustomFoodName">Food Name</label>
           <input id="mobileCustomFoodName" type="text" placeholder="e.g., Chicken Salad" />
         </div>
         <div class="field">
           <label class="label" for="mobileCustomFoodCalories">Calories</label>
           <input id="mobileCustomFoodCalories" type="number" placeholder="350" />
         </div>
         <div class="result" id="mobileCustomFoodResult"></div>
         <div class="user-actions">
           <button class="primary" id="mobileCustomFoodCalc">Add Food</button>
           <button class="ghost" id="closeMobileCustomFood">Close</button>
         </div>
       </div>
     </div>

         <!-- Main App Content (hidden until authenticated) -->
     <div id="appContent" class="hidden">

      <!-- Total Burned -->
      <section class="card">
        <h2>Total Calorie Deficit</h2>
        <canvas id="totalChart" height="200"></canvas>
        <button class="ghost" id="toggleFat">Show More</button>
        <button class="primary" id="addCaloriesBtn">Add Calories</button>
      </section>

             <!-- Weight Trajectory -->
       <section class="card">
         <h2>Weight Trajectory</h2>
         <canvas id="weightChart" height="200"></canvas>
         <button class="ghost" id="toggleWeightFat">Show Fat Loss</button>
         <button class="primary" id="addWeightBtn">Add Weight</button>
       </section>

      <!-- Workouts Menu (hidden by default) -->
      <section class="card hidden" id="workoutMenu">
        <h2>Choose a Workout</h2>
        <div class="menu-grid">
          <div class="menu-tile" id="openTreadmill">
            <div class="menu-emoji">üèÉ‚Äç‚ôÇÔ∏è</div>
            <div>Treadmill</div>
          </div>
          <div class="menu-tile" id="openStairs">
            <div class="menu-emoji">üßó</div>
            <div>Stair Master</div>
          </div>
        </div>
        <button class="ghost" id="hideWorkouts">Hide Workouts</button>
      </section>

             <!-- Show/Hide Workouts Button -->
       <section class="card" id="workoutToggleSection">
         <h2>Calories Burnt With Workouts</h2>
         <canvas id="workoutChart" height="200"></canvas>
         <button class="ghost" id="toggleWorkoutFat">Show Fat Loss</button>
         <button class="primary" id="showWorkouts">Show Workouts</button>
       </section>

                            <!-- Treadmill Section -->
       <section class="card hidden" id="treadmillSection">
        <h2>Treadmill Calories ¬∑ ACSM Walking Equation</h2>
        <div class="field">
          <label class="label" for="tspeed">Speed (mph)</label>
          <input id="tspeed" type="number" step="0.1" placeholder="3.5" />
        </div>
        <div class="field">
          <label class="label" for="tgrade">Incline (%)</label>
          <input id="tgrade" type="number" step="0.1" placeholder="7.5" />
        </div>
        <div class="field">
          <label class="label" for="tdur">Duration (min)</label>
          <input id="tdur" type="number" placeholder="30" />
        </div>
                 <div class="result" id="tresult"></div>
         <button class="primary" id="tcalc">Calculate Calories</button>
         <canvas id="tchart" height="200"></canvas>
         <button class="ghost" id="toggleTreadmillFat">Show Fat Loss</button>
         <button class="primary" id="backFromTreadmill">Back</button>
      </section>

      <!-- Stair Master Section -->
      <section class="card hidden" id="stairSection">
        <h2>Stair Master Calories ¬∑ MET Method</h2>
        <div class="field">
          <label class="label" for="sdur">Duration (min)</label>
          <input id="sdur" type="number" placeholder="20" />
        </div>
        <div class="field">
          <label class="label" for="sintensity">Intensity</label>
          <select id="sintensity">
            <option value="6">Easy ¬∑ 6 MET</option>
            <option value="8.8" selected>Moderate ¬∑ 8.8 MET</option>
            <option value="10.3">Hard ¬∑ 10.3 MET</option>
            <option value="custom">Custom MET</option>
          </select>
        </div>
        <div class="field hidden" id="customMetField">
          <label class="label" for="scustom">Custom MET</label>
          <input id="scustom" type="number" step="0.1" placeholder="9.5" />
        </div>
                 <div class="result" id="sresult"></div>
         <button class="primary" id="scalc">Calculate Calories</button>
         <canvas id="schart" height="200"></canvas>
         <button class="ghost" id="toggleStairsFat">Show Fat Loss</button>
                  <button class="primary" id="backFromStairs">Back</button>
       </section>

       <!-- Settings and Logout Section -->
       <section class="card">

        <h2>User Profile</h2>

         <div class="user-actions">
           <button class="settings-btn" id="openSettings" disabled>Settings</button>
           <button class="danger-btn" id="deleteAccountBtn">Delete Account</button>
           <button class="logout-btn" id="logoutBtn">Logout</button>
         </div>
       </section>
     </div>
     </div> <!-- Close desktop-container -->
   </div>

  <script>
    // ===== Firebase Configuration =====
    const firebaseConfig = {
      apiKey: "AIzaSyCgu5VzQcD0hPEpcslrizbiat_Q8VKPa3I",
      authDomain: "workout-b4051.firebaseapp.com",
      projectId: "workout-b4051",
      storageBucket: "workout-b4051.firebasestorage.app",
      messagingSenderId: "162149362879",
      appId: "1:162149362879:web:7db78878fa79bf9b4eea0a",
      measurementId: "G-6Y3WBWFE98"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

         // ===== Modal Management =====
    function liftModalsToBody() {
      const ids = [
        'authModal',
        'profileModal',
        'settingsModal',
        'addCaloriesModal',
        'weightLoggingModal',
        'addWeightModal',
        'mobileWorkoutModal',
        'mobileTreadmillModal',
        'mobileStairsModal',
        'mobileFoodModal',
        'mobileTacosModal',
        'mobileBurgerModal',
        'mobileCustomFoodModal'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.parentElement !== document.body) {
          document.body.appendChild(el);
        }
      });
    }

    // ===== Authentication State Management =====
     let currentUser = null;
     let userProfile = null;
     let authStateInitialized = false;

     auth.onAuthStateChanged(async (user) => {
       console.log('Auth state changed:', user ? 'User logged in' : 'No user');
       
       if (user) {
         currentUser = user;
         console.log('User signed in:', user.email);
         
         // Check if user has profile
         try {
           const profileDoc = await db.collection('users').doc(user.uid).get();
           if (profileDoc.exists) {
             userProfile = profileDoc.data();
             console.log('Profile found, showing app');
             showApp();
             loadUserData();
           } else {
             console.log('No profile found, showing profile setup');
             showProfileSetup();
           }
         } catch (error) {
           console.error('Error checking profile:', error);
           showAuthModal();
         }
                } else {
           currentUser = null;
           userProfile = null;
           console.log('No user, showing auth modal');
           // Ensure all modals are hidden first
           hideAllModals();
           showAuthModal();
         }
       
       // Mark auth state as initialized
       authStateInitialized = true;
     });

     // Show auth modal immediately for first-time users
     setTimeout(() => {
       console.log('Checking auth state - authStateInitialized:', authStateInitialized);
       if (!authStateInitialized) {
         console.log('Showing auth modal for first-time user');
         showAuthModal();
       }
     }, 100);

    // ===== UI State Management =====
         function hideAllModals() {
       console.log('Hiding all modals');
       document.getElementById('authModal').classList.add('hidden');
       document.getElementById('profileModal').classList.add('hidden');
       const settingsModal = document.getElementById('settingsModal');
       settingsModal.classList.add('hidden');
       const addCaloriesModal = document.getElementById('addCaloriesModal');
       addCaloriesModal.classList.add('hidden');
       const addWeightModal = document.getElementById('addWeightModal');
       addWeightModal.classList.add('hidden');
       const weightLoggingModal = document.getElementById('weightLoggingModal');
       weightLoggingModal.classList.add('hidden');
       
       // Hide mobile modals
       const mobileWorkoutModal = document.getElementById('mobileWorkoutModal');
       mobileWorkoutModal.classList.add('hidden');
       const mobileTreadmillModal = document.getElementById('mobileTreadmillModal');
       mobileTreadmillModal.classList.add('hidden');
       const mobileStairsModal = document.getElementById('mobileStairsModal');
       mobileStairsModal.classList.add('hidden');
       
       document.getElementById('appContent').classList.add('hidden');
     }

         function showAuthModal() {
       console.log('showAuthModal called');
       
       // Ensure all other modals are hidden first
       hideAllModals();
       
       const authModal = document.getElementById('authModal');
       authModal.classList.remove('hidden');
       authModal.style.zIndex = '2000';
       showSignupForm(); // Show signup form by default instead of login
     }

    function hideAuthModal() {
      document.getElementById('authModal').classList.add('hidden');
    }

         function showLoginForm() {
       document.getElementById('loginForm').classList.remove('hidden');
       document.getElementById('signupForm').classList.add('hidden');
     }

     function showSignupForm() {
       document.getElementById('loginForm').classList.add('hidden');
       document.getElementById('signupForm').classList.remove('hidden');
     }

    function showSignupForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.remove('hidden');
    }

    function showProfileSetup() {
      // Only show profile setup if user is authenticated
      if (!currentUser) {
        console.log('Cannot show profile setup - no authenticated user');
        showAuthModal();
        return;
      }
      
      console.log('Showing profile setup for user:', currentUser.email);
      document.getElementById('authModal').classList.add('hidden');
      const profileModal = document.getElementById('profileModal');
      profileModal.classList.remove('hidden');
      document.getElementById('appContent').classList.add('hidden');
    }

    function hideProfileSetup() {
      document.getElementById('profileModal').classList.add('hidden');
    }

         function showApp() {
       document.getElementById('authModal').classList.add('hidden');
       document.getElementById('profileModal').classList.add('hidden');
       document.getElementById('appContent').classList.remove('hidden');
       
       // Enable settings buttons
       const desk = document.getElementById('openSettings');
       if (desk) desk.disabled = false;
       const mob = document.getElementById('mobileOpenSettings');
       if (mob) mob.disabled = false;  // it was left disabled in HTML
     }

     function showAddCaloriesModal() {
       // Set today's date as default
       const today = new Date().toISOString().split('T')[0];
       document.getElementById('caloriesDate').value = today;
       document.getElementById('caloriesAmount').value = '';
       
       // Clear any previous messages
       document.getElementById('addCaloriesError').classList.add('hidden');
       document.getElementById('addCaloriesSuccess').classList.add('hidden');
       
       const addCaloriesModal = document.getElementById('addCaloriesModal');
       addCaloriesModal.classList.remove('hidden');
       
       // Ensure modal is visible on mobile
       addCaloriesModal.style.zIndex = '2000';
     }

     function hideAddCaloriesModal() {
       const addCaloriesModal = document.getElementById('addCaloriesModal');
       addCaloriesModal.classList.add('hidden');
     }

    function showSettings() {
      // Only show settings if user is authenticated
      if (!currentUser || !userProfile) {
        console.log('User not authenticated or profile not loaded');
        return;
      }
      
      // Populate settings with current values
      document.getElementById('settingsAge').value = userProfile.age || '';
      document.getElementById('settingsHeightFt').value = userProfile.heightFt || '';
      document.getElementById('settingsHeightIn').value = userProfile.heightIn || '';
      document.getElementById('settingsWeight').value = userProfile.weight || '';
      
      const settingsModal = document.getElementById('settingsModal');
      settingsModal.classList.remove('hidden');
    }

    function hideSettings() {
      const settingsModal = document.getElementById('settingsModal');
      settingsModal.classList.add('hidden');
    }

    // ===== Authentication Event Listeners =====
    document.getElementById('showSignup').addEventListener('click', showSignupForm);
    document.getElementById('showLogin').addEventListener('click', showLoginForm);


    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');

      try {
        await auth.signInWithEmailAndPassword(email, password);
        errorDiv.classList.add('hidden');
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      }
    });

    document.getElementById('signupBtn').addEventListener('click', async () => {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('signupError');

      if (password !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.classList.remove('hidden');
        return;
      }

      if (password.length < 6) {
        errorDiv.textContent = 'Password must be at least 6 characters';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        await auth.createUserWithEmailAndPassword(email, password);
        errorDiv.classList.add('hidden');
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      }
    });

    // ===== Profile Setup =====
    document.getElementById('saveProfileBtn').addEventListener('click', async () => {
      const age = +document.getElementById('setupAge').value;
      const heightFt = +document.getElementById('setupHeightFt').value;
      const heightIn = +document.getElementById('setupHeightIn').value;
      const weight = +document.getElementById('setupWeight').value;
      const errorDiv = document.getElementById('profileError');

      if (!age || !heightFt || !weight) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.classList.remove('hidden');
        return;
      }

             try {
         const bmr = calcBMR(age, weight, heightFt, heightIn);
         userProfile = { age, heightFt, heightIn, weight, bmr };
         
         await db.collection('users').doc(currentUser.uid).set(userProfile);
         
         // Log initial weight for today
         const today = todayStr();
         weightByDate[today] = weight;
         await saveUserData();
         
         hideProfileSetup();
         showApp();
         loadUserData();
         errorDiv.classList.add('hidden');
       } catch (error) {
         errorDiv.textContent = error.message;
         errorDiv.classList.remove('hidden');
       }
    });

    // ===== Settings Management =====
    document.getElementById('openSettings').addEventListener('click', () => {
      // Double-check authentication before showing settings
      if (!currentUser || !userProfile) {
        console.log('Settings access denied - user not authenticated');
        return;
      }
      showSettings();
    });
    document.getElementById('cancelSettings').addEventListener('click', hideSettings);
    


    document.getElementById('saveSettings').addEventListener('click', async () => {
      // Check if user is authenticated
      if (!currentUser) {
        const errorDiv = document.getElementById('settingsError');
        errorDiv.textContent = 'Please log in to save settings';
        errorDiv.classList.remove('hidden');
        return;
      }

      const age = +document.getElementById('settingsAge').value;
      const heightFt = +document.getElementById('settingsHeightFt').value;
      const heightIn = +document.getElementById('settingsHeightIn').value;
      const weight = +document.getElementById('settingsWeight').value;
      const errorDiv = document.getElementById('settingsError');
      const successDiv = document.getElementById('settingsSuccess');

      if (!age || !heightFt || !weight) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.classList.remove('hidden');
        successDiv.classList.add('hidden');
        return;
      }

      try {
        const bmr = calcBMR(age, weight, heightFt, heightIn);
        userProfile = { ...userProfile, age, heightFt, heightIn, weight, bmr };
        
        await db.collection('users').doc(currentUser.uid).update(userProfile);
        
                 // Update BMR calculation
         renderBMR(age, weight, heightFt, heightIn);
        
        errorDiv.classList.add('hidden');
        successDiv.textContent = 'Settings saved successfully!';
        successDiv.classList.remove('hidden');
        
        setTimeout(() => {
          successDiv.classList.add('hidden');
          hideSettings();
        }, 2000);
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        successDiv.classList.add('hidden');
      }
    });

         // ===== Logout =====
     document.getElementById('logoutBtn').addEventListener('click', () => {
       auth.signOut();
     });

     // ===== Delete Account =====
     document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
       if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
         try {
           await db.collection('users').doc(currentUser.uid).delete();
           await currentUser.delete();
           auth.signOut();
         } catch (error) {
           console.error('Error deleting account:', error);
           alert('Error deleting account. Please try again.');
         }
       }
     });

     // ===== Weight Logging Modal Event Listeners =====
     document.getElementById('submitDailyWeight').addEventListener('click', async () => {
       const weight = Number(document.getElementById('dailyWeight').value);
       const errorDiv = document.getElementById('weightLoggingError');
       
       if (!weight || weight <= 0) {
         errorDiv.textContent = 'Please enter a valid weight';
         errorDiv.classList.remove('hidden');
         return;
       }
       
       try {
         const today = todayStr();
         addWeightForDate(weight, today);
         hideWeightLoggingModal();
         errorDiv.classList.add('hidden');
       } catch (error) {
         errorDiv.textContent = error.message;
         errorDiv.classList.remove('hidden');
       }
     });

     document.getElementById('maybeLaterWeight').addEventListener('click', () => {
       hideWeightLoggingModal();
     });

     document.getElementById('closeWeightModal').addEventListener('click', () => {
       const today = todayStr();
       weightLoggingClosed[today] = true;
       saveUserData();
       hideWeightLoggingModal();
     });

     // ===== Add Weight Modal Event Listeners =====
     document.getElementById('addWeightBtn').addEventListener('click', showAddWeightModal);
     document.getElementById('cancelAddWeight').addEventListener('click', hideAddWeightModal);
     document.getElementById('submitAddWeight').addEventListener('click', () => {
       const weight = Number(document.getElementById('weightAmount').value);
       const date = document.getElementById('weightDate').value;
       const errorDiv = document.getElementById('addWeightError');
       const successDiv = document.getElementById('addWeightSuccess');
       
       if (!weight || !date) {
         errorDiv.textContent = 'Please fill in all fields';
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
         return;
       }
       
       if (weight <= 0) {
         errorDiv.textContent = 'Please enter a valid weight';
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
         return;
       }
       
       try {
         addWeightForDate(weight, date);
         errorDiv.classList.add('hidden');
         successDiv.textContent = 'Weight logged successfully!';
         successDiv.classList.remove('hidden');
         
         setTimeout(() => {
           hideAddWeightModal();
         }, 1500);
       } catch (error) {
         errorDiv.textContent = error.message;
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
       }
     });

    // ===== Data Management =====
         async function loadUserData() {
       if (!currentUser) return;

       try {
         // Load user's progress data
         const progressDoc = await db.collection('users').doc(currentUser.uid).collection('progress').doc('data').get();
         if (progressDoc.exists) {
           const data = progressDoc.data();
           basalByDate = data.basalByDate || {};
           activityByDate = data.activityByDate || {};
           weightByDate = data.weightByDate || {};
           workoutDataByDate = data.workoutDataByDate || {};
           foodDataByDate = data.foodDataByDate || {};
           customFoods = data.customFoods || {};
           weightLoggingClosed = data.weightLoggingClosed || {};
           updateCharts();
         }

                  // Calculate and display BMR from user profile
         if (userProfile) {
           renderBMR(userProfile.age, userProfile.weight, userProfile.heightFt, userProfile.heightIn);
         }

         // Load workout charts with saved data
         loadTreadmillChart();
         loadStairsChart();

         // Update food menu with custom foods
         updateFoodMenu();

         // Check for daily weight logging only if user has a profile
         if (userProfile) {
           checkDailyWeightLogging();
         }
       } catch (error) {
         console.error('Error loading user data:', error);
       }
     }

         async function saveUserData() {
       if (!currentUser) return;

       try {
         await db.collection('users').doc(currentUser.uid).collection('progress').doc('data').set({
           basalByDate,
           activityByDate,
           weightByDate,
           workoutDataByDate,
           foodDataByDate,
           customFoods,
           weightLoggingClosed,
           lastUpdated: new Date()
         });
       } catch (error) {
         console.error('Error saving user data:', error);
       }
     }

         // ===== Helper Functions =====
     function todayStr(){return new Date().toISOString().split('T')[0];}

     // ===== Weight Tracking Functions =====
     function checkDailyWeightLogging() {
       const today = todayStr();
       
       // Don't show if already logged or closed for today
       if (weightByDate[today] || weightLoggingClosed[today]) {
         return;
       }
       
       // Show weight logging modal
       showWeightLoggingModal();
     }

     function showWeightLoggingModal() {
       const weightLoggingModal = document.getElementById('weightLoggingModal');
       weightLoggingModal.classList.remove('hidden');
     }

     function hideWeightLoggingModal() {
       const weightLoggingModal = document.getElementById('weightLoggingModal');
       weightLoggingModal.classList.add('hidden');
     }

     function showAddWeightModal() {
       const today = new Date().toISOString().split('T')[0];
       document.getElementById('weightDate').value = today;
       document.getElementById('weightAmount').value = '';
       
       // Clear any previous messages
       document.getElementById('addWeightError').classList.add('hidden');
       document.getElementById('addWeightSuccess').classList.add('hidden');
       
       const addWeightModal = document.getElementById('addWeightModal');
       addWeightModal.classList.remove('hidden');
     }

     function hideAddWeightModal() {
       const addWeightModal = document.getElementById('addWeightModal');
       addWeightModal.classList.add('hidden');
     }

     function showMobileWorkoutMenu() {
       const mobileWorkoutModal = document.getElementById('mobileWorkoutModal');
       mobileWorkoutModal.classList.remove('hidden');
       mobileWorkoutModal.style.zIndex = '2000';
     }

     function hideMobileWorkoutMenu() {
       const mobileWorkoutModal = document.getElementById('mobileWorkoutModal');
       mobileWorkoutModal.classList.add('hidden');
     }

     function showMobileTreadmillModal() {
       const mobileTreadmillModal = document.getElementById('mobileTreadmillModal');
       mobileTreadmillModal.classList.remove('hidden');
       mobileTreadmillModal.style.zIndex = '2000';
       
       // Set default values
       document.getElementById('mobileTspeed').value = 3.5;
       document.getElementById('mobileTgrade').value = 7.5;
       document.getElementById('mobileTdur').value = 30;
       previewMobileTreadmill();
     }

     function hideMobileTreadmillModal() {
       const mobileTreadmillModal = document.getElementById('mobileTreadmillModal');
       mobileTreadmillModal.classList.add('hidden');
     }

     function showMobileStairsModal() {
       const mobileStairsModal = document.getElementById('mobileStairsModal');
       mobileStairsModal.classList.remove('hidden');
       mobileStairsModal.style.zIndex = '2000';
       
       // Set default values
       document.getElementById('mobileSdur').value = 20;
       document.getElementById('mobileSintensity').value = '8.8';
     }

     function hideMobileStairsModal() {
       const mobileStairsModal = document.getElementById('mobileStairsModal');
       mobileStairsModal.classList.add('hidden');
     }

     function showMobileFoodMenu() {
       const mobileFoodModal = document.getElementById('mobileFoodModal');
       mobileFoodModal.classList.remove('hidden');
       mobileFoodModal.style.zIndex = '2000';
     }

     function hideMobileFoodMenu() {
       const mobileFoodModal = document.getElementById('mobileFoodModal');
       mobileFoodModal.classList.add('hidden');
     }

     function showMobileTacosModal() {
       const mobileTacosModal = document.getElementById('mobileTacosModal');
       mobileTacosModal.classList.remove('hidden');
       mobileTacosModal.style.zIndex = '2000';
       
       // Set default values
       document.getElementById('mobileTacoName').value = 'Beef Taco';
       document.getElementById('mobileTacoCalories').value = 250;
       document.getElementById('mobileTacoQuantity').value = 2;
       previewMobileTacos();
     }

     function hideMobileTacosModal() {
       const mobileTacosModal = document.getElementById('mobileTacosModal');
       mobileTacosModal.classList.add('hidden');
     }

     function showMobileBurgerModal() {
       const mobileBurgerModal = document.getElementById('mobileBurgerModal');
       mobileBurgerModal.classList.remove('hidden');
       mobileBurgerModal.style.zIndex = '2000';
       
       // Set default values
       document.getElementById('mobileBurgerName').value = 'Cheeseburger';
       document.getElementById('mobileBurgerCalories').value = 500;
       document.getElementById('mobileBurgerQuantity').value = 1;
       previewMobileBurger();
     }

     function hideMobileBurgerModal() {
       const mobileBurgerModal = document.getElementById('mobileBurgerModal');
       mobileBurgerModal.classList.add('hidden');
     }

     function showMobileCustomFoodModal(existingFood = null) {
       const mobileCustomFoodModal = document.getElementById('mobileCustomFoodModal');
       mobileCustomFoodModal.classList.remove('hidden');
       mobileCustomFoodModal.style.zIndex = '2000';
       
       if (existingFood) {
         // Editing existing food
         document.getElementById('mobileCustomFoodName').value = existingFood.name;
         document.getElementById('mobileCustomFoodCalories').value = existingFood.calories;
         document.getElementById('customFoodIcon').textContent = existingFood.icon;
         document.getElementById('mobileCustomFoodCalc').textContent = 'Update Food';
       } else {
         // Adding new food
         document.getElementById('mobileCustomFoodName').value = '';
         document.getElementById('mobileCustomFoodCalories').value = '';
         document.getElementById('customFoodIcon').textContent = 'üçΩÔ∏è';
         document.getElementById('mobileCustomFoodCalc').textContent = 'Add Food';
       }
       document.getElementById('mobileCustomFoodResult').innerHTML = '';
     }

     function hideMobileCustomFoodModal() {
       const mobileCustomFoodModal = document.getElementById('mobileCustomFoodModal');
       mobileCustomFoodModal.classList.add('hidden');
     }

     function updateCustomFoodIcon() {
       const foodName = document.getElementById('mobileCustomFoodName').value;
       const icon = pickEmoji(foodName);
       document.getElementById('customFoodIcon').textContent = icon;
     }

     function updateFoodMenu() {
       const foodMenu = document.getElementById('mobileFoodModal');
       const menuGrid = foodMenu.querySelector('.menu-grid');
       
       // Start with default foods
       let menuHTML = `
         <div class="menu-tile" id="mobileOpenTacos">
           <div class="menu-emoji">üåÆ</div>
           <div>Tacos</div>
         </div>
         <div class="menu-tile" id="mobileOpenBurger">
           <div class="menu-emoji">üçî</div>
           <div>Burger</div>
         </div>
       `;
       
       // Add custom foods
       Object.values(customFoods).forEach(food => {
         menuHTML += `
           <div class="menu-tile" id="mobileOpenCustom_${food.name.replace(/\s+/g, '_')}">
             <div class="menu-emoji">${food.icon}</div>
             <div>${food.name}</div>
           </div>
         `;
       });
       
       menuGrid.innerHTML = menuHTML;
       
       // Re-attach event listeners for custom foods
       Object.values(customFoods).forEach(food => {
         const elementId = `mobileOpenCustom_${food.name.replace(/\s+/g, '_')}`;
         const element = document.getElementById(elementId);
         if (element) {
           element.addEventListener('click', () => {
             hideMobileFoodMenu();
             showMobileCustomFoodModal(food);
           });
         }
       });
     }

     function previewMobileTacos() {
       const calories = +document.getElementById('mobileTacoCalories').value;
       const quantity = +document.getElementById('mobileTacoQuantity').value;
       
       if (calories > 0 && quantity > 0) {
         const total = calories * quantity;
         document.getElementById('mobileTacoResult').innerHTML = `<div class='math'>Preview ‚âà ${Math.round(total)} kcal</div>`;
       } else {
         document.getElementById('mobileTacoResult').innerHTML = '';
       }
     }

     function previewMobileBurger() {
       const calories = +document.getElementById('mobileBurgerCalories').value;
       const quantity = +document.getElementById('mobileBurgerQuantity').value;
       
       if (calories > 0 && quantity > 0) {
         const total = calories * quantity;
         document.getElementById('mobileBurgerResult').innerHTML = `<div class='math'>Preview ‚âà ${Math.round(total)} kcal</div>`;
       } else {
         document.getElementById('mobileBurgerResult').innerHTML = '';
       }
     }

     function previewMobileTreadmill() {
       const w = userProfile?.weight || 170;
       const s = +document.getElementById('mobileTspeed').value;
       const g = +document.getElementById('mobileTgrade').value;
       const m = +document.getElementById('mobileTdur').value;
       
       if (w > 0 && s > 0 && g >= 0 && m > 0) {
         const total = calcTreadmillKcal(w, s, g, m);
         document.getElementById('mobileTresult').innerHTML = `<div class='math'>Preview ‚âà ${Math.round(total)} kcal</div>`;
       } else {
         document.getElementById('mobileTresult').innerHTML = '';
       }
     }

     function addWeightForDate(weight, date) {
       weightByDate[date] = weight;
       console.log('Weight added for date:', date, 'weight:', weight);
       console.log('Current weightByDate:', weightByDate);
       updateCharts();
       saveUserData();
     }
    function mphToMmin(mph){return mph*26.8224}
    function calcTreadmillKcal(lbs,mph,gradePct,minutes){
      const kg=lbs/2.2046;const speed=mphToMmin(mph);const grade=gradePct/100;
      const vo2=0.1*speed+1.8*speed*grade+3.5;
      const kcalPerMin=(vo2*kg)/200;return kcalPerMin*minutes;
    }
    function calcStairKcal(lbs, minutes, met){
      const kg=lbs/2.2046;const kcalPerMin=(met*3.5*kg)/200;return kcalPerMin*minutes;
    }

         // ===== State =====
     let bmr=0;
     let basalByDate={};     // date -> BMR for that date
     let activityByDate={};  // date -> sum of activity kcal for that date
     let weightByDate={};    // date -> weight for that date
     let workoutDataByDate={}; // date -> workout data for that date
     let foodDataByDate={};  // date -> food data for that date
     let customFoods={};     // custom food name -> {name, calories, icon}
     let weightLoggingClosed={}; // date -> whether weight logging was closed for that date

    // ===== BMR =====
    function toKg(lbs){return lbs/2.2046}
    function toCm(ft,inch){return ft*30.48+inch*2.54}
    function calcBMR(age,lbs,ft,inch){
      const kg=toKg(lbs),cm=toCm(ft,inch);
      return 10*kg+6.25*cm-5*age+5;
    }
    function setBasalForToday(value){
      basalByDate[todayStr()]=Math.round(value);
      updateCharts();
      saveUserData();
    }
    function addActivityForToday(value){
      const d=todayStr();
      if(!activityByDate[d]) activityByDate[d]=0;
      activityByDate[d]+=Math.round(value);
      updateCharts();
      saveUserData();
    }
         function renderBMR(age,lbs,ft,inch){
       bmr=Math.round(calcBMR(age,lbs,ft,inch));
       setBasalForToday(bmr); // auto include BMR in daily total for the day
     }

         // BMR calculation is now handled automatically from user profile

         // ===== Charts =====
     let totalCtx=document.getElementById('totalChart').getContext('2d');
     let totalChart=new Chart(totalCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Calorie Deficit',data:[],borderColor:'#6ee7b7',backgroundColor:'rgba(110,231,183,.3)',fill:true,tension:0.25}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Calories'}}}}
     });

     // Mobile Charts
     let mobileTotalCtx=document.getElementById('mobileTotalChart').getContext('2d');
     let mobileTotalChart=new Chart(mobileTotalCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Calorie Deficit',data:[],borderColor:'#6ee7b7',backgroundColor:'rgba(110,231,183,.3)',fill:true,tension:0.25}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Calories'}}}}
     });

         let weightCtx=document.getElementById('weightChart').getContext('2d');
     let weightChart=new Chart(weightCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Actual Weight',data:[],borderColor:'#6ee7b7',fill:false,tension:0.25},
         {label:'Projected Weight',data:[],borderColor:'#60a5fa',borderDash:[5,5],fill:false,tension:0.25}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:false}}}
     });

     let mobileWeightCtx=document.getElementById('mobileWeightChart').getContext('2d');
     let mobileWeightChart=new Chart(mobileWeightCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Actual Weight',data:[],borderColor:'#6ee7b7',fill:false,tension:0.25},
         {label:'Projected Weight',data:[],borderColor:'#60a5fa',borderDash:[5,5],fill:false,tension:0.25}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:false}}}
     });

     let workoutCtx=document.getElementById('workoutChart').getContext('2d');
     let workoutChart=new Chart(workoutCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Workout Calories',data:[],borderColor:'#6ee7b7',backgroundColor:'rgba(110,231,183,.3)',fill:true,tension:0.25}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Calories'}}}}
     });

     let mobileWorkoutCtx=document.getElementById('mobileWorkoutChart').getContext('2d');
     let mobileWorkoutChart=new Chart(mobileWorkoutCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Workout Calories',data:[],borderColor:'#6ee7b7',backgroundColor:'rgba(110,231,183,.3)',fill:true,tension:0.25}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Calories'}}}}
     });

     // Mobile Food Chart
     let mobileFoodCtx=document.getElementById('mobileFoodChart').getContext('2d');
     let mobileFoodChart=new Chart(mobileFoodCtx,{
       type:'line',
       data:{labels:[],datasets:[
         {label:'Food Calories',data:[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.3)',fill:true,tension:0.25}
       ]},
       options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Calories'}}}}
     });

         function getAllDates(){
       const set=new Set([...Object.keys(basalByDate),...Object.keys(activityByDate)]);
       return Array.from(set).sort();
     }

     // ===== Mobile Swipe Navigation =====
     let currentSlide = 0;
     const totalSlides = 5;
     let startX = 0;
     let currentX = 0;
     let isDragging = false;

     function showSlide(slideIndex) {
       // Hide all slides first
       for (let i = 0; i < totalSlides; i++) {
         const slide = document.getElementById(`mobile-slide-${i + 1}`);
         const indicator = document.querySelectorAll('.mobile-indicator')[i];
         
         slide.classList.remove('active', 'prev', 'next');
         slide.style.display = 'none';
         indicator.classList.remove('active');
       }

       // Show current slide
       const currentSlideElement = document.getElementById(`mobile-slide-${slideIndex + 1}`);
       const currentIndicator = document.querySelectorAll('.mobile-indicator')[slideIndex];
       
       currentSlideElement.style.display = 'flex';
       currentSlideElement.classList.add('active');
       currentIndicator.classList.add('active');

       // Set previous slide for swipe animation
       const prevIndex = slideIndex === 0 ? totalSlides - 1 : slideIndex - 1;
       const prevSlide = document.getElementById(`mobile-slide-${prevIndex + 1}`);
       prevSlide.style.display = 'flex';
       prevSlide.classList.add('prev');

       // Set next slide for swipe animation
       const nextIndex = slideIndex === totalSlides - 1 ? 0 : slideIndex + 1;
       const nextSlide = document.getElementById(`mobile-slide-${nextIndex + 1}`);
       nextSlide.style.display = 'flex';
       nextSlide.classList.add('next');
     }

     function nextSlide() {
       currentSlide = (currentSlide + 1) % totalSlides;
       showSlide(currentSlide);
     }

     function prevSlide() {
       currentSlide = currentSlide === 0 ? totalSlides - 1 : currentSlide - 1;
       showSlide(currentSlide);
     }

     // Touch event handlers
     let startY = 0;
     let isVerticalScroll = false;
     let hasMoved = false;

     function handleTouchStart(e) {
       // Don't start swipe detection if touching a button or interactive element
       if (e.target.tagName === 'BUTTON' || e.target.closest('button') || 
           e.target.tagName === 'INPUT' || e.target.closest('input') ||
           e.target.tagName === 'SELECT' || e.target.closest('select')) {
         return;
       }
       
       startX = e.touches[0].clientX;
       startY = e.touches[0].clientY;
       isDragging = true;
       isVerticalScroll = false;
       hasMoved = false;
     }

     function handleTouchMove(e) {
       if (!isDragging) return;
       
       currentX = e.touches[0].clientX;
       const currentY = e.touches[0].clientY;
       const diffX = startX - currentX;
       const diffY = startY - currentY;
       
       // Check if we've moved enough to consider it a gesture
       if (Math.abs(diffX) > 5 || Math.abs(diffY) > 5) {
         hasMoved = true;
       }
       
       // Determine if this is a vertical scroll or horizontal swipe
       if (!isVerticalScroll && Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 10) {
         isVerticalScroll = true;
         return; // Allow normal scrolling
       }
       
       // Only handle horizontal swipes
       if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) {
         e.preventDefault(); // Prevent scrolling during horizontal swipe
         
         // Add visual feedback only for significant swipes
         const activeSlide = document.querySelector('.mobile-slide.active');
         if (Math.abs(diffX) > 20) {
           activeSlide.style.transform = `translateX(${-diffX}px)`;
         }
       }
     }

     function handleTouchEnd(e) {
       if (!isDragging || isVerticalScroll || !hasMoved) {
         isDragging = false;
         isVerticalScroll = false;
         hasMoved = false;
         return;
       }
       
       isDragging = false;
       const diff = startX - currentX;
       const threshold = 80; // Increased threshold to prevent accidental swipes
       
       // Reset transform
       const activeSlide = document.querySelector('.mobile-slide.active');
       activeSlide.style.transform = '';
       
       if (Math.abs(diff) > threshold) {
         if (diff > 0) {
           // Swipe left - next slide
           nextSlide();
         } else {
           // Swipe right - previous slide
           prevSlide();
         }
       }
       
       hasMoved = false;
     }

     // Initialize mobile swipe
     function initMobileSwipe() {
       const mobileContainer = document.querySelector('.mobile-container');
       if (mobileContainer) {
         mobileContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
         mobileContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
         mobileContainer.addEventListener('touchend', handleTouchEnd, { passive: false });
       }
     }

         // Food icon mapping
         const FOOD_MAP = new Map([
           // drinks
           ["milk","ü•õ"], ["glass of milk","ü•õ"], ["oat milk","ü•õ"], ["soy milk","ü•õ"], ["milk tea","üßã"],
           ["water","üíß"], ["juice","üßÉ"], ["apple juice","üßÉ"], ["orange juice","üßÉ"],
           ["soda","ü•§"], ["cola","ü•§"], ["soft drink","ü•§"], ["milkshake","ü•§"],
           ["coffee","‚òï"], ["latte","‚òï"], ["espresso","‚òï"], ["tea","üçµ"], ["green tea","üçµ"], ["teapot","ü´ñ"],
           ["boba","üßã"], ["bubble tea","üßã"], ["smoothie","ü•§"],
           ["beer","üç∫"], ["beers","üçª"], ["wine","üç∑"], ["champagne","üçæ"], ["sake","üç∂"], ["cocktail","üç∏"], ["tropical drink","üçπ"], ["mate","üßâ"],

           // mains and fast food
           ["burger","üçî"], ["hamburger","üçî"], ["cheeseburger","üçî"],
           ["pizza","üçï"], ["slice","üçï"],
           ["hot dog","üå≠"], ["hotdog","üå≠"],
           ["taco","üåÆ"], ["burrito","üåØ"], ["tamale","ü´î"],
           ["sandwich","ü•™"], ["wrap","üåØ"], ["flatbread","ü´ì"],
           ["fries","üçü"], ["french fries","üçü"], ["pizza fries","üçü"],
           ["dumpling","ü•ü"], ["gyoza","ü•ü"], ["bao","ü•ü"], ["bento","üç±"], ["takeout","ü•°"],
           ["sushi","üç£"], ["ramen","üçú"], ["noodles","üçú"], ["pho","üçú"], ["spaghetti","üçù"], ["pasta","üçù"],
           ["curry","üçõ"], ["curry rice","üçõ"], ["rice","üçö"], ["rice ball","üçô"], ["rice cracker","üçò"],
           ["soup","üç≤"], ["stew","üç≤"], ["bowl","ü•£"], ["fondue","ü´ï"],
           ["bbq","üçñ"], ["steak","ü•©"], ["meat","ü•©"], ["bacon","ü•ì"], ["chicken","üçó"], ["drumstick","üçó"], ["wings","üçó"],
           ["fried shrimp","üç§"], ["shrimp","üç§"], ["lobster","ü¶û"], ["crab","ü¶Ä"], ["oyster","ü¶™"], ["canned food","ü•´"],
           ["egg","ü•ö"], ["omelet","üç≥"], ["omelette","üç≥"],
           ["salad","ü•ó"], ["taco salad","ü•ó"],

           // breads and breakfast
           ["bread","üçû"], ["baguette","ü•ñ"], ["croissant","ü•ê"], ["bagel","ü•Ø"], ["pancakes","ü•û"], ["waffle","üßá"],

           // sweets
           ["donut","üç©"], ["doughnut","üç©"], ["ice cream","üç®"], ["soft serve","üç¶"], ["shaved ice","üçß"],
           ["cake","üç∞"], ["birthday cake","üéÇ"], ["cupcake","üßÅ"], ["pie","ü•ß"],
           ["cookie","üç™"], ["candy","üç¨"], ["lollipop","üç≠"], ["chocolate","üç´"], ["honey","üçØ"],

           // cheese and pantry
           ["cheese","üßÄ"], ["butter","üßà"], ["salt","üßÇ"], ["jar","ü´ô"],

           // produce
           ["apple","üçé"], ["green apple","üçè"], ["banana","üçå"], ["strawberry","üçì"], ["blueberries","ü´ê"],
           ["grapes","üçá"], ["orange","üçä"], ["lemon","üçã"], ["pear","üçê"], ["peach","üçë"], ["mango","ü•≠"],
           ["pineapple","üçç"], ["melon","üçà"], ["watermelon","üçâ"], ["kiwi","ü•ù"], ["coconut","ü••"],
           ["avocado","ü•ë"], ["tomato","üçÖ"], ["corn","üåΩ"], ["carrot","ü•ï"], ["potato","ü•î"], ["sweet potato","üç†"],
           ["mushroom","üçÑ"], ["eggplant","üçÜ"], ["cucumber","ü•í"], ["pickle","ü•í"], ["broccoli","ü•¶"], ["leafy greens","ü•¨"], ["lettuce","ü•¨"],
           ["bell pepper","ü´ë"], ["pepper","üå∂Ô∏è"], ["garlic","üßÑ"], ["onion","üßÖ"], ["beans","ü´ò"], ["peanuts","ü•ú"], ["chestnut","üå∞"], ["olive","ü´í"],

           // misc
           ["popcorn","üçø"], ["coffee beans","‚òï"], ["bento box","üç±"], ["takeout box","ü•°"]
         ]);

         // Food icon helper functions
         function normalizeTerm(s) {
           return s.toLowerCase().replace(/[-_]+/g, ' ').replace(/\s+/g, ' ').trim();
         }

         function pickEmoji(input) {
           const hasEmoji = /\p{Extended_Pictographic}/u.test(input);
           if (hasEmoji) {
             // Return the first emoji char
             const match = input.match(/\p{Extended_Pictographic}(\uFE0F\u20E3|\uFE0F|\u200D\p{Extended_Pictographic})*/u);
             if (match) return match[0];
           }
           const t = normalizeTerm(input);
           if (FOOD_MAP.has(t)) return FOOD_MAP.get(t);
           // Try simple plural trim
           if (t.endsWith('es') && FOOD_MAP.has(t.slice(0, -2))) return FOOD_MAP.get(t.slice(0, -2));
           if (t.endsWith('s') && FOOD_MAP.has(t.slice(0, -1))) return FOOD_MAP.get(t.slice(0, -1));
           // Try removing common words
           const simplified = t.replace(/^(a|an|the)\s+/g, '').replace(/\s+emoji$/g, '');
           if (FOOD_MAP.has(simplified)) return FOOD_MAP.get(simplified);
           // Light fuzzy fallback
           const keys = Array.from(FOOD_MAP.keys()).sort((a,b)=>b.length - a.length);
           for (const k of keys) {
             if (simplified.includes(k) || k.includes(simplified)) return FOOD_MAP.get(k);
           }
           return 'üçΩÔ∏è'; // Default food emoji
         }

         // Put this helper above updateCharts()
         function computeWeightSeries(weightByDate, futureDays = 3) {
           // Collect actual points, sorted
           const actualDates = Object.keys(weightByDate)
             .filter(d => typeof weightByDate[d] === 'number' && !isNaN(weightByDate[d]))
             .sort();

           if (actualDates.length === 0) {
             return { labels: [], actual: [], projected: [] };
           }

           // Build recent slice for trend (up to last 3 actual points)
           const recentDates = actualDates.slice(-3);
           const recentPoints = recentDates.map(d => ({
             date: d,
             ts: new Date(d).getTime(),
             w: weightByDate[d]
           }));

           // Average daily change
           let slopePerDay = 0;
           if (recentPoints.length >= 2) {
             const first = recentPoints[0];
             const last = recentPoints[recentPoints.length - 1];
             const days = Math.max(1, Math.round((last.ts - first.ts) / (1000 * 60 * 60 * 24)));
             slopePerDay = (last.w - first.w) / days;
           } // if only one point, slope remains 0

           // Labels = all actual dates + next N future dates
           const lastDate = new Date(actualDates[actualDates.length - 1]);
           const futureLabels = [];
           for (let i = 1; i <= futureDays; i++) {
             const d = new Date(lastDate.getTime() + i * 24 * 60 * 60 * 1000);
             futureLabels.push(d.toISOString().split('T')[0]);
           }
           const labels = [...actualDates, ...futureLabels];

           // Actual values align to labels, null for future
           const actual = labels.map(d => (weightByDate[d] ?? null));

           // Projected values: null for all past labels except the last actual index,
           // then extend using slope for future labels
           const projected = new Array(labels.length).fill(null);
           const lastIdx = actualDates.length - 1;
           const lastWeight = weightByDate[actualDates[lastIdx]];
           projected[lastIdx] = lastWeight; // anchor so the dotted line starts here
           for (let i = 1; i <= futureDays; i++) {
             projected[lastIdx + i] = lastWeight + slopePerDay * i;
           }

           return { labels, actual, projected };
         }

         function updateCharts(){
       const labels=getAllDates();
       const daily=labels.map(d=> (basalByDate[d]||0) + (activityByDate[d]||0));
       let cumulative=[];let sum=0;daily.forEach(v=>{sum+=v;cumulative.push(sum)});

       // Calculate food calories eaten per day
       const foodCalories = labels.map(d => {
         let total = 0;
         if (foodDataByDate[d]) {
           if (foodDataByDate[d].tacos && foodDataByDate[d].tacos.totalCalories) {
             total += foodDataByDate[d].tacos.totalCalories;
           }
           if (foodDataByDate[d].burger && foodDataByDate[d].burger.totalCalories) {
             total += foodDataByDate[d].burger.totalCalories;
           }
         }
         return total;
       });

       // Calculate calorie deficit (calories burned - calories eaten)
       const calorieDeficit = labels.map((d, i) => daily[i] - foodCalories[i]);

       // Total calories chart - check if showing detailed view
       totalChart.data.labels=labels;
       const isDetailed = totalChart.data.datasets.length > 1;
       
       if (isDetailed) {
         // Show detailed view with both calories burned and eaten
         totalChart.data.datasets[0].data = daily; // Calories burned
         totalChart.data.datasets[1].data = foodCalories; // Calories eaten
       } else {
         // Show calorie deficit
         totalChart.data.datasets[0].data = calorieDeficit;
       }
       totalChart.update();

       // Mobile total calories chart - check if showing detailed view
       mobileTotalChart.data.labels=labels;
       const isMobileDetailed = mobileTotalChart.data.datasets.length > 1;
       
       if (isMobileDetailed) {
         // Show detailed view with both calories burned and eaten
         mobileTotalChart.data.datasets[0].data = daily; // Calories burned
         mobileTotalChart.data.datasets[1].data = foodCalories; // Calories eaten
       } else {
         // Show calorie deficit
         mobileTotalChart.data.datasets[0].data = calorieDeficit;
       }
       mobileTotalChart.update();

       // Workout calories chart
       const workoutCalories = labels.map(d => {
         let total = 0;
         if (workoutDataByDate[d]) {
           if (workoutDataByDate[d].treadmill && workoutDataByDate[d].treadmill.calories) {
             total += workoutDataByDate[d].treadmill.calories;
           }
           if (workoutDataByDate[d].stairs && workoutDataByDate[d].stairs.calories) {
             total += workoutDataByDate[d].stairs.calories;
           }
         }
         return total;
       });
       
       workoutChart.data.labels = labels;
       const isWorkoutFat = workoutChart.options.scales.y.title?.text==='Fat Loss (lbs)';
       workoutChart.data.datasets[0].data = isWorkoutFat ? workoutCalories.map(v=>v/3500) : workoutCalories;
       workoutChart.update();

       // Mobile workout calories chart
       mobileWorkoutChart.data.labels = labels;
       const isMobileWorkoutFat = mobileWorkoutChart.options.scales.y.title?.text==='Fat Loss (lbs)';
       mobileWorkoutChart.data.datasets[0].data = isMobileWorkoutFat ? workoutCalories.map(v=>v/3500) : workoutCalories;
       mobileWorkoutChart.update();

       // Food calories chart (using existing foodCalories variable)
       
       // Mobile food calories chart
       mobileFoodChart.data.labels = labels;
       const isMobileFoodFat = mobileFoodChart.options.scales.y.title?.text==='Fat Loss (lbs)';
       mobileFoodChart.data.datasets[0].data = isMobileFoodFat ? foodCalories.map(v=>v/3500) : foodCalories;
       mobileFoodChart.update();

       // ===== Weight charts =====
       if (userProfile) {
         const { labels: wLabels, actual: wActual, projected: wProjected } =
           computeWeightSeries(weightByDate, 3);

         // Desktop
         weightChart.data.labels = wLabels;
         const isWeightFat = weightChart.options.scales.y.title?.text === 'Fat Loss (lbs)';
         if (isWeightFat) {
           // unchanged behavior when toggled to fat loss
           const daily = wLabels.map(d => ((basalByDate[d] || 0) + (activityByDate[d] || 0)));
           const perDayFat = daily.map(v => v / 3500);
           weightChart.data.datasets[0].data = perDayFat;
           weightChart.data.datasets[1].data = perDayFat;
         } else {
           weightChart.data.datasets[0].data = wActual;        // green: actual
           weightChart.data.datasets[1].data = wProjected;     // blue dotted: projected only after last actual
         }
         weightChart.update();

         // Mobile
         mobileWeightChart.data.labels = wLabels;
         const isMobileWeightFat = mobileWeightChart.options.scales.y.title?.text === 'Fat Loss (lbs)';
         if (isMobileWeightFat) {
           const daily = wLabels.map(d => ((basalByDate[d] || 0) + (activityByDate[d] || 0)));
           const perDayFat = daily.map(v => v / 3500);
           mobileWeightChart.data.datasets[0].data = perDayFat;
           mobileWeightChart.data.datasets[1].data = perDayFat;
         } else {
           mobileWeightChart.data.datasets[0].data = wActual;
           mobileWeightChart.data.datasets[1].data = wProjected;
         }
         mobileWeightChart.update();
       }
     }

    // ===== Treadmill =====
    let tctx=document.getElementById('tchart').getContext('2d');
    let tchart=new Chart(tctx,{type:'line',data:{labels:[],datasets:[{label:'Calories Burned',data:[],borderColor:'#6ee7b7',fill:false,tension:0.25}]},options:{scales:{y:{beginAtZero:true}}}});

         function treadmillInputs(){
       return {w:userProfile?.weight||170,s:+tspeed.value,g:+tgrade.value,m:+tdur.value};
     }

     function saveTreadmillInputs() {
       const inputs = treadmillInputs();
       const today = todayStr();
       if (!workoutDataByDate[today]) {
         workoutDataByDate[today] = {};
       }
       workoutDataByDate[today].treadmill = inputs;
       saveUserData();
     }

     function loadTreadmillInputs() {
       const today = todayStr();
       if (workoutDataByDate[today] && workoutDataByDate[today].treadmill) {
         const data = workoutDataByDate[today].treadmill;
         tspeed.value = data.s || 3.5;
         tgrade.value = data.g || 7.5;
         tdur.value = data.m || 30;
         previewTreadmill();
       } else {
         // Set default values if no saved data
         tspeed.value = 3.5;
         tgrade.value = 7.5;
         tdur.value = 30;
         previewTreadmill();
       }
     }

     function loadTreadmillChart() {
       // Clear existing chart data
       tchart.data.labels = [];
       tchart.data.datasets[0].data = [];
       
       // Load treadmill data from Firebase
       const dates = Object.keys(workoutDataByDate).sort();
       dates.forEach(date => {
         if (workoutDataByDate[date].treadmill && workoutDataByDate[date].treadmill.calories) {
           tchart.data.labels.push(date);
           tchart.data.datasets[0].data.push(workoutDataByDate[date].treadmill.calories);
         }
       });
       tchart.update();
     }

     function loadStairsChart() {
       // Clear existing chart data
       schart.data.labels = [];
       schart.data.datasets[0].data = [];
       
       // Load stairs data from Firebase
       const dates = Object.keys(workoutDataByDate).sort();
       dates.forEach(date => {
         if (workoutDataByDate[date].stairs && workoutDataByDate[date].stairs.calories) {
           schart.data.labels.push(date);
           schart.data.datasets[0].data.push(workoutDataByDate[date].stairs.calories);
         }
       });
       schart.update();
     }
    function previewTreadmill(){
      const {w,s,g,m}=treadmillInputs();
      if(w>0 && s>0 && g>=0 && m>0){
        const total=calcTreadmillKcal(w,s,g,m);
        tresult.innerHTML=`<div class='math'>Preview ‚âà ${Math.round(total)} kcal</div>`;
      } else {
        tresult.innerHTML='';
      }
    }
         function renderTreadmill(lbs,mph,gradePct,minutes){
       const total=calcTreadmillKcal(lbs,mph,gradePct,minutes);
       tresult.innerHTML=`<div class='math'>Logged ‚âà ${Math.round(total)} kcal</div>`;
       addActivityForToday(total);
       
       // Save workout data to Firebase for graphs
       const today=todayStr();
       if (!workoutDataByDate[today]) {
         workoutDataByDate[today] = {};
       }
       workoutDataByDate[today].treadmill = {
         w: lbs, s: mph, g: gradePct, m: minutes,
         calories: Math.round(total)
       };
       saveUserData();
       
       // Update treadmill chart
       tchart.data.labels.push(today);
       tchart.data.datasets[0].data.push(Math.round(total));
       tchart.update();
       
       // Update overall workout chart
       updateCharts();
     }
         ['input','change'].forEach(evt=>{
       tspeed.addEventListener(evt,()=>{
         previewTreadmill();
         saveTreadmillInputs();
       });
       tgrade.addEventListener(evt,()=>{
         previewTreadmill();
         saveTreadmillInputs();
       });
       tdur.addEventListener(evt,()=>{
         previewTreadmill();
         saveTreadmillInputs();
       });
     });
         tcalc.addEventListener('click',()=>{
       const {w,s,g,m}=treadmillInputs();
       if(!w||!s||!g||!m){tresult.innerHTML='<p>Please enter all values</p>';return;}
       renderTreadmill(w,s,g,m);
     });

    // ===== Stairs =====
    let sctx=document.getElementById('schart').getContext('2d');
    let schart=new Chart(sctx,{type:'line',data:{labels:[],datasets:[{label:'Calories Burned',data:[],borderColor:'#6ee7b7',fill:false,tension:0.25}]},options:{scales:{y:{beginAtZero:true}}}});

    sintensity.addEventListener('change',()=>{
      const isCustom = sintensity.value==='custom';
      document.getElementById('customMetField').classList.toggle('hidden', !isCustom);
    });
         function renderStairs(lbs, minutes, met){
       const total=calcStairKcal(lbs, minutes, met);
       sresult.innerHTML=`<div class='math'>‚âà ${Math.round(total)} kcal burned</div>`;
       addActivityForToday(total);
       
       // Save workout data to Firebase for graphs
       const today=todayStr();
       if (!workoutDataByDate[today]) {
         workoutDataByDate[today] = {};
       }
       workoutDataByDate[today].stairs = {
         w: lbs, m: minutes, met: met,
         calories: Math.round(total)
       };
       saveUserData();
       
       // Update stairs chart
       schart.data.labels.push(today);
       schart.data.datasets[0].data.push(Math.round(total));
       schart.update();
       
       // Update overall workout chart
       updateCharts();
     }
         scalc.addEventListener('click',()=>{
       const w=userProfile?.weight||170, m=+sdur.value;
       let met = sintensity.value==='custom' ? +scustom.value : +sintensity.value;
       if(!w||!m||!met){sresult.innerHTML='<p>Please enter all values</p>';return;}
       renderStairs(w, m, met);
     });

    // ===== Workouts Menu Show/Hide =====
    const workoutMenu=document.getElementById('workoutMenu');
    const showBtn=document.getElementById('showWorkouts');
    const toggleSection=document.getElementById('workoutToggleSection');

    function setShowBtnVisible(vis){ toggleSection.style.display = vis ? '' : 'none'; }
    function setMenuVisible(vis){ workoutMenu.classList.toggle('hidden', !vis); }

         showBtn.addEventListener('click',()=>{
       const willShow = workoutMenu.classList.contains('hidden');
       setMenuVisible(willShow);
       showBtn.textContent = willShow ? 'Hide Workouts' : 'Show Workouts';
       // Hide the toggle button when workouts are shown
       setShowBtnVisible(!willShow);
     });

         document.getElementById('hideWorkouts').addEventListener('click',()=>{
       setMenuVisible(false);
       showBtn.textContent = 'Show Workouts';
       // Show the toggle button when workouts are hidden
       setShowBtnVisible(true);
     });

         document.getElementById('openTreadmill').addEventListener('click',()=>{
       setMenuVisible(false);
       document.getElementById('treadmillSection').classList.remove('hidden');
       setShowBtnVisible(false);
       loadTreadmillInputs();
       loadTreadmillChart();
     });
         document.getElementById('openStairs').addEventListener('click',()=>{
       setMenuVisible(false);
       document.getElementById('stairSection').classList.remove('hidden');
       setShowBtnVisible(false);
       loadStairsChart();
     });
         document.getElementById('backFromTreadmill').addEventListener('click',()=>{
       document.getElementById('treadmillSection').classList.add('hidden');
       setMenuVisible(true);
       setShowBtnVisible(false);
       showBtn.textContent='Hide Workouts';
     });
     document.getElementById('backFromStairs').addEventListener('click',()=>{
       document.getElementById('stairSection').classList.add('hidden');
       setMenuVisible(true);
       setShowBtnVisible(false);
       showBtn.textContent='Hide Workouts';
     });

         // ===== Show More Toggle =====
     document.getElementById('toggleFat').addEventListener('click',()=>{
       const isDetailed = totalChart.data.datasets.length > 1;
       if (isDetailed) {
         // Switch back to deficit view
         totalChart.data.datasets = [{
           label: 'Calorie Deficit',
           data: [],
           borderColor: '#6ee7b7',
           backgroundColor: 'rgba(110,231,183,.3)',
           fill: true,
           tension: 0.25
         }];
         document.getElementById('toggleFat').textContent = 'Show More';
       } else {
         // Switch to detailed view
         totalChart.data.datasets = [
           {
             label: 'Calories Burned',
             data: [],
             borderColor: '#6ee7b7',
             backgroundColor: 'rgba(110,231,183,.3)',
             fill: true,
             tension: 0.25
           },
           {
             label: 'Calories Eaten',
             data: [],
             borderColor: '#f59e0b',
             backgroundColor: 'rgba(245,158,11,.3)',
             fill: true,
             tension: 0.25
           }
         ];
         document.getElementById('toggleFat').textContent = 'Show Deficit';
       }
       updateCharts();
     });

     // Mobile show more toggles
     document.getElementById('mobileToggleFat').addEventListener('click',()=>{
       const isDetailed = mobileTotalChart.data.datasets.length > 1;
       if (isDetailed) {
         // Switch back to deficit view
         mobileTotalChart.data.datasets = [{
           label: 'Calorie Deficit',
           data: [],
           borderColor: '#6ee7b7',
           backgroundColor: 'rgba(110,231,183,.3)',
           fill: true,
           tension: 0.25
         }];
         document.getElementById('mobileToggleFat').textContent = 'Show More';
       } else {
         // Switch to detailed view
         mobileTotalChart.data.datasets = [
           {
             label: 'Calories Burned',
             data: [],
             borderColor: '#6ee7b7',
             backgroundColor: 'rgba(110,231,183,.3)',
             fill: true,
             tension: 0.25
           },
           {
             label: 'Calories Eaten',
             data: [],
             borderColor: '#f59e0b',
             backgroundColor: 'rgba(245,158,11,.3)',
             fill: true,
             tension: 0.25
           }
         ];
         document.getElementById('mobileToggleFat').textContent = 'Show Deficit';
       }
       updateCharts();
     });

     document.getElementById('mobileToggleWeightFat').addEventListener('click',()=>{
       const isFat=mobileWeightChart.options.scales.y.title?.text==='Fat Loss (lbs)';
       mobileWeightChart.options.scales.y.title={display:true,text: isFat ? 'Weight (lbs)' : 'Fat Loss (lbs)'};
       updateCharts();
     });

     document.getElementById('mobileToggleWorkoutFat').addEventListener('click',()=>{
       const isFat=mobileWorkoutChart.options.scales.y.title?.text==='Fat Loss (lbs)';
       mobileWorkoutChart.options.scales.y.title={display:true,text: isFat ? 'Calories' : 'Fat Loss (lbs)'};
       updateCharts();
     });

     document.getElementById('mobileToggleFoodFat').addEventListener('click',()=>{
       const isFat=mobileFoodChart.options.scales.y.title?.text==='Fat Loss (lbs)';
       mobileFoodChart.options.scales.y.title={display:true,text: isFat ? 'Calories' : 'Fat Loss (lbs)'};
       updateCharts();
     });

     document.getElementById('toggleWorkoutFat').addEventListener('click',()=>{
       const isFat=workoutChart.options.scales.y.title?.text==='Fat Loss (lbs)';
       workoutChart.options.scales.y.title={display:true,text: isFat ? 'Calories' : 'Fat Loss (lbs)'};
       updateCharts();
     });

     document.getElementById('toggleWeightFat').addEventListener('click',()=>{
       const isFat=weightChart.options.scales.y.title?.text==='Fat Loss (lbs)';
       weightChart.options.scales.y.title={display:true,text: isFat ? 'Weight (lbs)' : 'Fat Loss (lbs)'};
       updateCharts();
     });

     document.getElementById('toggleTreadmillFat').addEventListener('click',()=>{
       const isFat=tchart.options.scales.y.title?.text==='Fat Loss (lbs)';
       tchart.options.scales.y.title={display:true,text: isFat ? 'Calories' : 'Fat Loss (lbs)'};
       tchart.update();
     });

     document.getElementById('toggleStairsFat').addEventListener('click',()=>{
       const isFat=schart.options.scales.y.title?.text==='Fat Loss (lbs)';
       schart.options.scales.y.title={display:true,text: isFat ? 'Calories' : 'Fat Loss (lbs)'};
       schart.update();
     });

         // ===== Manual Add Calories =====
     document.getElementById('addCaloriesBtn').addEventListener('click', showAddCaloriesModal);
     
     // Mobile button event listeners
     document.getElementById('mobileAddCaloriesBtn').addEventListener('click', showAddCaloriesModal);
     document.getElementById('mobileAddWeightBtn').addEventListener('click', showAddWeightModal);
     document.getElementById('mobileShowWorkouts').addEventListener('click', () => {
       // Show mobile workout menu modal
       showMobileWorkoutMenu();
     });
     document.getElementById('mobileShowFoods').addEventListener('click', () => {
       // Show mobile food menu modal
       showMobileFoodMenu();
     });
     document.getElementById('mobileOpenSettings').addEventListener('click', showSettings);
     document.getElementById('mobileDeleteAccountBtn').addEventListener('click', async () => {
       if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
         try {
           await db.collection('users').doc(currentUser.uid).delete();
           await currentUser.delete();
           auth.signOut();
         } catch (error) {
           console.error('Error deleting account:', error);
           alert('Error deleting account. Please try again.');
         }
       }
     });
     document.getElementById('mobileLogoutBtn').addEventListener('click', () => {
       auth.signOut();
     });
     
     // Mobile workout menu event listeners
     document.getElementById('closeMobileWorkoutMenu').addEventListener('click', hideMobileWorkoutMenu);
     document.getElementById('mobileOpenTreadmill').addEventListener('click', () => {
       hideMobileWorkoutMenu();
       showMobileTreadmillModal();
     });
     document.getElementById('mobileOpenStairs').addEventListener('click', () => {
       hideMobileWorkoutMenu();
       showMobileStairsModal();
     });
     
     // Mobile food menu event listeners
     document.getElementById('closeMobileFoodMenu').addEventListener('click', hideMobileFoodMenu);
     document.getElementById('mobileAddCustomFood').addEventListener('click', () => {
       hideMobileFoodMenu();
       showMobileCustomFoodModal();
     });
     document.getElementById('mobileOpenTacos').addEventListener('click', () => {
       hideMobileFoodMenu();
       showMobileTacosModal();
     });
     document.getElementById('mobileOpenBurger').addEventListener('click', () => {
       hideMobileFoodMenu();
       showMobileBurgerModal();
     });
     
     // Mobile treadmill event listeners
     document.getElementById('closeMobileTreadmill').addEventListener('click', hideMobileTreadmillModal);
     document.getElementById('mobileTcalc').addEventListener('click', () => {
       const w = userProfile?.weight || 170;
       const s = +document.getElementById('mobileTspeed').value;
       const g = +document.getElementById('mobileTgrade').value;
       const m = +document.getElementById('mobileTdur').value;
       
       if (!w || !s || !g || !m) {
         document.getElementById('mobileTresult').innerHTML = '<p>Please enter all values</p>';
         return;
       }
       
       const total = calcTreadmillKcal(w, s, g, m);
       document.getElementById('mobileTresult').innerHTML = `<div class='math'>Logged ‚âà ${Math.round(total)} kcal</div>`;
       addActivityForToday(total);
       
       // Save workout data to Firebase for graphs
       const today = todayStr();
       if (!workoutDataByDate[today]) {
         workoutDataByDate[today] = {};
       }
       workoutDataByDate[today].treadmill = {
         w: w, s: s, g: g, m: m,
         calories: Math.round(total)
       };
       saveUserData();
       
       // Update charts
       updateCharts();
       
       // Close modal after a short delay
       setTimeout(() => {
         hideMobileTreadmillModal();
       }, 2000);
     });
     
     // Mobile stairs event listeners
     document.getElementById('closeMobileStairs').addEventListener('click', hideMobileStairsModal);
     document.getElementById('mobileScalc').addEventListener('click', () => {
       const w = userProfile?.weight || 170;
       const m = +document.getElementById('mobileSdur').value;
       let met = document.getElementById('mobileSintensity').value === 'custom' ? 
         +document.getElementById('mobileScustom').value : 
         +document.getElementById('mobileSintensity').value;
       
       if (!w || !m || !met) {
         document.getElementById('mobileSresult').innerHTML = '<p>Please enter all values</p>';
         return;
       }
       
       const total = calcStairKcal(w, m, met);
       document.getElementById('mobileSresult').innerHTML = `<div class='math'>‚âà ${Math.round(total)} kcal burned</div>`;
       addActivityForToday(total);
       
       // Save workout data to Firebase for graphs
       const today = todayStr();
       if (!workoutDataByDate[today]) {
         workoutDataByDate[today] = {};
       }
       workoutDataByDate[today].stairs = {
         w: w, m: m, met: met,
         calories: Math.round(total)
       };
       saveUserData();
       
       // Update charts
       updateCharts();
       
       // Close modal after a short delay
       setTimeout(() => {
         hideMobileStairsModal();
       }, 2000);
     });
     
     // Mobile treadmill input event listeners
     ['input', 'change'].forEach(evt => {
       document.getElementById('mobileTspeed').addEventListener(evt, previewMobileTreadmill);
       document.getElementById('mobileTgrade').addEventListener(evt, previewMobileTreadmill);
       document.getElementById('mobileTdur').addEventListener(evt, previewMobileTreadmill);
     });
     
     // Mobile stairs intensity change listener
     document.getElementById('mobileSintensity').addEventListener('change', () => {
       const isCustom = document.getElementById('mobileSintensity').value === 'custom';
       document.getElementById('mobileCustomMetField').classList.toggle('hidden', !isCustom);
     });
     
     // Mobile food calculation event listeners
     document.getElementById('mobileTacoCalc').addEventListener('click', () => {
       const name = document.getElementById('mobileTacoName').value;
       const calories = +document.getElementById('mobileTacoCalories').value;
       const quantity = +document.getElementById('mobileTacoQuantity').value;
       
       if (!name || !calories || !quantity) {
         document.getElementById('mobileTacoResult').innerHTML = '<p>Please enter all values</p>';
         return;
       }
       
       const total = calories * quantity;
       document.getElementById('mobileTacoResult').innerHTML = `<div class='math'>Logged ‚âà ${Math.round(total)} kcal</div>`;
       
       // Save food data to Firebase
       const today = todayStr();
       if (!foodDataByDate[today]) {
         foodDataByDate[today] = {};
       }
       foodDataByDate[today].tacos = {
         name: name,
         calories: calories,
         quantity: quantity,
         totalCalories: Math.round(total)
       };
       saveUserData();
       
       // Update charts
       updateCharts();
       
       // Close modal after a short delay
       setTimeout(() => {
         hideMobileTacosModal();
       }, 2000);
     });
     
     document.getElementById('mobileBurgerCalc').addEventListener('click', () => {
       const name = document.getElementById('mobileBurgerName').value;
       const calories = +document.getElementById('mobileBurgerCalories').value;
       const quantity = +document.getElementById('mobileBurgerQuantity').value;
       
       if (!name || !calories || !quantity) {
         document.getElementById('mobileBurgerResult').innerHTML = '<p>Please enter all values</p>';
         return;
       }
       
       const total = calories * quantity;
       document.getElementById('mobileBurgerResult').innerHTML = `<div class='math'>Logged ‚âà ${Math.round(total)} kcal</div>`;
       
       // Save food data to Firebase
       const today = todayStr();
       if (!foodDataByDate[today]) {
         foodDataByDate[today] = {};
       }
       foodDataByDate[today].burger = {
         name: name,
         calories: calories,
         quantity: quantity,
         totalCalories: Math.round(total)
       };
       saveUserData();
       
       // Update charts
       updateCharts();
       
       // Close modal after a short delay
       setTimeout(() => {
         hideMobileBurgerModal();
       }, 2000);
     });
     
     // Mobile food input event listeners
     ['input', 'change'].forEach(evt => {
       document.getElementById('mobileTacoName').addEventListener(evt, previewMobileTacos);
       document.getElementById('mobileTacoCalories').addEventListener(evt, previewMobileTacos);
       document.getElementById('mobileTacoQuantity').addEventListener(evt, previewMobileTacos);
       document.getElementById('mobileBurgerName').addEventListener(evt, previewMobileBurger);
       document.getElementById('mobileBurgerCalories').addEventListener(evt, previewMobileBurger);
       document.getElementById('mobileBurgerQuantity').addEventListener(evt, previewMobileBurger);
     });
     
     // Mobile custom food event listeners
     document.getElementById('mobileCustomFoodCalc').addEventListener('click', () => {
       const name = document.getElementById('mobileCustomFoodName').value;
       const calories = +document.getElementById('mobileCustomFoodCalories').value;
       
       if (!name || !calories) {
         document.getElementById('mobileCustomFoodResult').innerHTML = '<p>Please enter both name and calories</p>';
         return;
       }
       
       if (calories <= 0) {
         document.getElementById('mobileCustomFoodResult').innerHTML = '<p>Please enter a valid calorie amount</p>';
         return;
       }
       
       // Save custom food to Firebase
       const icon = pickEmoji(name);
       customFoods[name] = {
         name: name,
         calories: calories,
         icon: icon
       };
       saveUserData();
       
       // Update food menu to show new custom food
       updateFoodMenu();
       
       const isUpdate = document.getElementById('mobileCustomFoodCalc').textContent === 'Update Food';
       document.getElementById('mobileCustomFoodResult').innerHTML = `<div class='math'>${isUpdate ? 'Updated' : 'Added'}: ${name} (${calories} kcal)</div>`;
       
       // Close modal after a short delay
       setTimeout(() => {
         hideMobileCustomFoodModal();
       }, 2000);
     });
     
     // Mobile custom food input event listeners
     document.getElementById('mobileCustomFoodName').addEventListener('input', updateCustomFoodIcon);
     
     // Mobile food modal close event listeners
     document.getElementById('closeMobileTacos').addEventListener('click', hideMobileTacosModal);
     document.getElementById('closeMobileBurger').addEventListener('click', hideMobileBurgerModal);
     document.getElementById('closeMobileCustomFood').addEventListener('click', hideMobileCustomFoodModal);
     
     // Add Calories Modal Event Listeners
     document.getElementById('cancelAddCalories').addEventListener('click', hideAddCaloriesModal);
     document.getElementById('submitAddCalories').addEventListener('click', () => {
       const calories = Number(document.getElementById('caloriesAmount').value);
       const date = document.getElementById('caloriesDate').value;
       const errorDiv = document.getElementById('addCaloriesError');
       const successDiv = document.getElementById('addCaloriesSuccess');
       
       if (!calories || !date) {
         errorDiv.textContent = 'Please fill in all fields';
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
         return;
       }
       
       if (isNaN(calories)) {
         errorDiv.textContent = 'Please enter a valid number';
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
         return;
       }
       
       try {
         // Add calories for the specific date
         const d = date;
         if (!activityByDate[d]) activityByDate[d] = 0;
         activityByDate[d] += Math.round(calories);
         updateCharts();
         saveUserData();
         
         errorDiv.classList.add('hidden');
         successDiv.textContent = 'Calories updated successfully!';
         successDiv.classList.remove('hidden');
         
         setTimeout(() => {
           hideAddCaloriesModal();
         }, 1500);
       } catch (error) {
         errorDiv.textContent = error.message;
         errorDiv.classList.remove('hidden');
         successDiv.classList.add('hidden');
       }
     });

         // Initialize app
     window.addEventListener('DOMContentLoaded',()=>{
       console.log('DOM loaded, initializing app...');
       
       liftModalsToBody(); // <-- make modals visible on mobile
       
       // Prefill example values for profile setup
       document.getElementById('setupAge').value=22;
       document.getElementById('setupHeightFt').value=5;
       document.getElementById('setupHeightIn').value=9;
       document.getElementById('setupWeight').value=170;
       
       // Prefill treadmill preview with defaults
       tspeed.value=3.5; tgrade.value=7.5; tdur.value=30; previewTreadmill();
       
                // Initialize mobile swipe functionality
       initMobileSwipe();
       
       // Initialize mobile slides
       showSlide(0);
       
       // Initialize food menu
       updateFoodMenu();
       
       // Ensure auth modal shows for new users
       if (!currentUser) {
         setTimeout(() => {
           showAuthModal();
         }, 300);
       }
       
       // Force show auth modal initially, then let Firebase auth state take over
       setTimeout(() => {
         console.log('Initial timeout - authStateInitialized:', authStateInitialized);
         if (!authStateInitialized) {
           console.log('Showing auth modal initially');
           showAuthModal();
         }
       }, 200);
     });
  </script>
</body>
</html>